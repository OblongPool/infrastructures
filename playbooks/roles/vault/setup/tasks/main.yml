---
- name: Add apt signing key
  apt_key:
    url: https://apt.releases.hashicorp.com/gpg
    state: present

- name: Add hashicorp repository
  apt_repository:
    repo: deb [arch=amd64] https://apt.releases.hashicorp.com buster main
    state: present
    mode: 0644

- name: Install Vault
  apt:
    update_cache: yes
    name:
      - vault

- name: Generate an CA private key with the default values (4096 bits, RSA) and a passphrase
  become: no
  local_action:
    module: openssl_privatekey
    path: "./roles/vault/setup/files/{{ VAULT_FQDN }}.key"
    cipher: aes256
    passphrase: 

- name: Generate an CA Certificate Signing Request
  become: no
  local_action:
    module: openssl_csr
    path: "./roles/vault/setup/files/{{ VAULT_FQDN }}.csr"
    privatekey_path: "roles/vault/setup/files/{{ VAULT_FQDN }}.key"
    common_name: "{{ VAULT_FQDN }}"
    basic_constraints: 'CA:TRUE'
    country_name: "CN"
    email_address: "admin@radix10.me"
    locality_name: "Beijing"
    state_or_province_name: "Beijing"

- name: Generate a Self Signed CA Certificate
  become: no
  local_action:
    module: openssl_certificate
    privatekey_path: "roles/vault/setup/files/{{ VAULT_FQDN }}.key"
    csr_path: "roles/vault/setup/files/{{ VAULT_FQDN }}.csr"
    path: "roles/vault/setup/files/{{ VAULT_FQDN }}.crt"
    provider: selfsigned

- name: Copy Self Signed CA Certificate
  copy:
    src: "roles/vault/setup/files/{{ item.src }}"
    dest: "/opt/vault/tls/{{ item.dest }}"
  with_items:
    - { src: "{{ VAULT_FQDN }}.key", dest: tls.key }
    - { src: "{{ VAULT_FQDN }}.crt", dest: tls.crt }
