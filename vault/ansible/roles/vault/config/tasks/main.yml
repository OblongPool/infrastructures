---
- name: Update vault ip address
  become: false
  local_action:
    module: replace
    path: ./roles/coredns/config/defaults/main.yml
    regexp: 'VAULT_IP:.*'
    replace: "VAULT_IP: {{ ansible_facts.enp0s8.ipv4.address }}"

- name: Append vault ip address
  become: false
  local_action:
    module: lineinfile
    dest: ./roles/coredns/config/defaults/main.yml
    line: "VAULT_IP: {{ ansible_facts.enp0s8.ipv4.address }}"
    state: present

- name: Add default vault address to bashrc
  lineinfile:
    dest: /root/.bashrc
    line: export VAULT_ADDR='https://Vault:8200'
    state: present

- name: Enable vault service
  systemd:
    name: vault
    enabled: true
  notify: Initializing the vault

- name: Start vault service
  systemd:
    name: vault
    state: started

- name: Fetch vault certificate
  fetch:
    src: "/opt/vault/tls/{{ item }}"
    dest: "./roles/common/config/files/{{ item }}"
    flat: true
  with_items:
    - tls.crt
    - tls.key
